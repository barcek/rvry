#!/bin/bash

# rvry v 1.2.0
# Â©2022 barcek
# License: MIT
# @ github.com
# /barcek/rvry

# loops, waiting for $beat seconds for use of the $sign key,
# printing one $mark and incrementing $path by 1 each cycle;
# if either $sign or Ctrl-C is pressed, prints the duration
# w/ any $tag, and if any $log appends all w/ a start stamp

mark=. # characters printed
path=0 # initial step count
beat=1 # secs between steps
sign=q # key pressed to end

# handle any arguments provided

if [ "$1" == "--help" ] || [ "$1" == "-h" ]; then
  echo "Usage: rvry [tag [log] / --help/-h]"
  exit 1
fi

if ! [ -z "$1" ]; then
  tag=$1
fi

if ! [ -z "$2" ]; then
  log=$2
  dt0=$(date)
fi

# define primary loop functions

heed() {
  read -t $beat -N 1 char
  if [ $sign == "$char" ]; then
    wake
  fi
}

step() {
  echo -n $mark
  ((path++))
}

# define wake process functions

form() {
  secs=$((path*$beat))
  view=$(printf "%02d:%02d:%02d" $(($secs%86400/3600)) $(($secs%3600/60)) $(($secs%60)))
  if [ -n "$tag" ]; then
    view+=" ${tag}"
  fi
  echo "${view}"
}

keep() {
  if [ -n "$log" ]; then
    echo $dt0 $1 >> $log
  fi
}

show() {
  wipe="\033[2K\r"
  echo -ne $wipe
  echo $1
}

wake() {
  view=$(form)
  keep "$view"
  show "$view"
  exit 1
}

# initiate

trap "wake" SIGINT

while [ true ]; do
  heed
  step
done
