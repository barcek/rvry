#!/bin/bash

# rvry v 1.1.0
# Â©2022 barcek
# License: MIT
# @ github.com
# /barcek/rvry

# loop listening for $beat seconds for $sign key pressed,
# printing $mark and incrementing $path by one each time,
# calling wake if pressed or SIGINT (Ctrl-C) received to
# print duration, any $tag and with datetime to any $log

mark=. # characters printed
path=0 # initial step count
beat=1 # secs between steps
sign=q # key pressed to end

# use any optional args present

if ! [ -z "$1" ]; then
  tag=$1
fi

if ! [ -z "$2" ]; then
  log=$2
  dt0=$(date)
fi

# define primary loop functions

heed() {
  read -t $beat -N 1 char
  if [ $sign == "$char" ]; then
    wake
  fi
}

step() {
  echo -n $mark
  ((path++))
}

# define wake process functions

form() {
  secs=$((path*$beat))
  view=$(printf "%02d:%02d:%02d" $(($secs%86400/3600)) $(($secs%3600/60)) $(($secs%60)))
  if [ -n "$tag" ]; then
    view+=" ${tag}"
  fi
  echo "${view}"
}

keep() {
  if [ -n "$log" ]; then
    echo $dt0 $1 >> $log
  fi
}

show() {
  wipe="\033[2K\r"
  echo -ne $wipe
  echo $1
}

wake() {
  view=$(form)
  keep "$view"
  show "$view"
  exit 1
}

# initiate

trap "wake" SIGINT

while [ true ]; do
  heed
  step
done
